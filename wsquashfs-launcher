#!/bin/bash

# Fonction pour récupérer une variable depuis le fichier autorun.cmd
getWine_var() {
    WINEPOINT=$1
    WINEVAR=$2
    WINEVALUE=$3

    if [[ -e "${WINEPOINT}/autorun.cmd" ]]; then
        VAL=$(grep "^${WINEVAR}=" "${WINEPOINT}/autorun.cmd" | sed -e "s/^${WINEVAR}=//" | head -1 | dos2unix)
        if [[ -n "${VAL}" ]]; then
            echo "${VAL}"
        else
            echo "${WINEVALUE}"
        fi
    else
        echo "${WINEVALUE}"
    fi
}

# Vérification des arguments
if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <fichier_wsquashfs>"
    exit 1
fi

# Variables
WSQUASHFS_FILE=$1
if [[ "${WSQUASHFS_FILE##*.}" != "wsquashfs" ]]; then
    echo "Erreur : Le fichier spécifié n'a pas l'extension .wsquashfs"
    exit 1
fi

BASE_NAME=$(basename "$WSQUASHFS_FILE" .wsquashfs)
MOUNT_POINT="$HOME/.squashfs/$BASE_NAME"
AUTORUN_FILE="$MOUNT_POINT/autorun.cmd"
BOTTLE_NAME="Soda" # Nom de la bouteille existante

# Vérification du fichier wsquashfs
if [[ ! -f "$WSQUASHFS_FILE" ]]; then
    echo "Erreur : Le fichier wsquashfs spécifié n'existe pas : $WSQUASHFS_FILE"
    exit 1
fi

# Contrôle si le point de montage existe déjà
if mountpoint -q "$MOUNT_POINT"; then
    echo "Le point de montage $MOUNT_POINT est déjà utilisé. Démontage..."
    if ! umount "$MOUNT_POINT"; then
        echo "Erreur : Impossible de démonter $MOUNT_POINT. Veuillez vérifier."
        exit 1
    fi
    echo "Démontage réussi."
fi

# Création du point de montage si nécessaire
if [[ ! -d "$MOUNT_POINT" ]]; then
    echo "Création du point de montage : $MOUNT_POINT"
    mkdir -p "$MOUNT_POINT" || { echo "Erreur : Impossible de créer le point de montage"; exit 1; }
fi

# Montage
echo "Montage de $WSQUASHFS_FILE sur $MOUNT_POINT"
if ! squashfuse "$WSQUASHFS_FILE" "$MOUNT_POINT"; then
    echo "Erreur : Échec du montage wsquashfs"
    exit 1
fi

# Vérification de l'existence de autorun.cmd
if [[ ! -f "$AUTORUN_FILE" ]]; then
    echo "Erreur : Le fichier autorun.cmd n'existe pas dans $MOUNT_POINT"
    umount "$MOUNT_POINT"
    rmdir "$MOUNT_POINT"
    exit 1
fi

# Utilisation de getWine_var pour récupérer toutes les variables de Batocera
DIR=$(getWine_var "$MOUNT_POINT" "DIR" "")
CMD=$(getWine_var "$MOUNT_POINT" "CMD" "")

# Variables Wine/Proton spécifiques à Batocera
WINE_VERSION=$(getWine_var "$MOUNT_POINT" "WINE" "")
PROTON_VERSION=$(getWine_var "$MOUNT_POINT" "PROTON" "")
RUNNER=$(getWine_var "$MOUNT_POINT" "RUNNER" "")
WINE_ARCH=$(getWine_var "$MOUNT_POINT" "ARCH" "win64")
DXVK=$(getWine_var "$MOUNT_POINT" "DXVK" "")
VKD3D=$(getWine_var "$MOUNT_POINT" "VKD3D" "")
ESYNC=$(getWine_var "$MOUNT_POINT" "ESYNC" "")
FSYNC=$(getWine_var "$MOUNT_POINT" "FSYNC" "")

# Vérification des variables extraites
if [[ -z "$CMD" ]]; then
    echo "Erreur : CMD n'est pas défini dans $AUTORUN_FILE"
    umount "$MOUNT_POINT"
    rmdir "$MOUNT_POINT"
    exit 1
fi

# Gestion du chemin complet
# Dans Batocera, DIR est relatif à la racine du prefix Wine (qui est le point de montage)
# Exemple: DIR=drive_c/Program Files/MyGame
if [[ -z "$DIR" ]]; then
    # Si DIR n'est pas défini, suppose que le fichier est à la racine du prefix
    EXEC_PATH="$MOUNT_POINT/$(echo "$CMD" | awk '{print $1}' | sed 's/^"//;s/"$//')"
    EXEC_ARGS=$(echo "$CMD" | cut -d' ' -f2-)
else
    # DIR est relatif au prefix Wine (MOUNT_POINT)
    EXEC_PATH="$MOUNT_POINT/$DIR/$(echo "$CMD" | awk '{print $1}' | sed 's/^"//;s/"$//')"
    EXEC_ARGS=$(echo "$CMD" | cut -d' ' -f2-)
fi

if [[ ! -f "$EXEC_PATH" ]]; then
    echo "Erreur : Le fichier exécutable spécifié n'existe pas : $EXEC_PATH"
    umount "$MOUNT_POINT"
    rmdir "$MOUNT_POINT"
    exit 1
fi

# Détection du type de fichier exécuté
EXT="${EXEC_PATH##*.}"

# Configuration du préfixe Wine
# IMPORTANT: Dans Batocera, le wsquashfs contient TOUT le prefix Wine (system.reg, user.reg, drive_c/, etc.)
# Le WINEPREFIX doit pointer vers le point de montage (MOUNT_POINT), pas vers un sous-répertoire
export WINEPREFIX="$MOUNT_POINT"
export WINEARCH="$WINE_ARCH"

# Vérifier la structure du prefix Wine
if [[ -f "$MOUNT_POINT/system.reg" ]] && [[ -d "$MOUNT_POINT/drive_c" ]]; then
    echo "✓ Préfixe Wine complet détecté dans le wsquashfs (structure Batocera)"
else
    echo "Attention: Le wsquashfs ne contient pas un préfixe Wine complet à la racine"
    echo "Structure attendue: system.reg, user.reg, drive_c/, etc. à la racine du wsquashfs"
fi

# Configuration des optimisations Wine/Proton
if [[ "$ESYNC" == "1" ]]; then
    export WINEESYNC=1
    echo "ESYNC activé"
fi

if [[ "$FSYNC" == "1" ]]; then
    export WINEFSYNC=1
    echo "FSYNC activé"
fi

# Déterminer si on utilise Wine ou Bottles
USE_BOTTLES=false
WINE_BINARY="wine"

# Support version Wine personnalisée
if [[ -n "$WINE_VERSION" ]]; then
    echo "Version Wine demandée : $WINE_VERSION"
    if [[ -x "/opt/wine-$WINE_VERSION/bin/wine" ]]; then
        WINE_BINARY="/opt/wine-$WINE_VERSION/bin/wine"
    else
        echo "Attention : Wine $WINE_VERSION non disponible, utilisation de Wine/Bottles par défaut"
    fi
fi

# Support Proton si spécifié
if [[ -n "$PROTON_VERSION" ]]; then
    echo "Version Proton demandée : $PROTON_VERSION"
    if [[ -x "/usr/local/bin/proton" ]]; then
        WINE_BINARY="proton"
    else
        echo "Attention : Proton non disponible"
    fi
fi

# Support runner personnalisé
if [[ -n "$RUNNER" ]]; then
    echo "Runner personnalisé : $RUNNER"
    if [[ -x "$RUNNER" ]]; then
        WINE_BINARY="$RUNNER"
    fi
fi

# Vérifier si Bottles est disponible et préféré (si aucune version Wine spécifique n'est demandée)
if [[ -z "$WINE_VERSION" ]] && [[ -z "$PROTON_VERSION" ]] && [[ -z "$RUNNER" ]]; then
    if command -v flatpak &> /dev/null && flatpak list | grep -q com.usebottles.bottles; then
        USE_BOTTLES=true
    fi
fi

# Construction de la commande
if [[ "$USE_BOTTLES" == true ]]; then
    # Utilisation de Bottles
    if [[ "$EXT" == "bat" ]]; then
        RUN_CMD="flatpak run --command=bottles-cli com.usebottles.bottles run -b \"$BOTTLE_NAME\" -e cmd -a \"/c \\\"$EXEC_PATH\\\" $EXEC_ARGS\""
    else
        if [[ -n "$EXEC_ARGS" ]]; then
            RUN_CMD="flatpak run --command=bottles-cli com.usebottles.bottles run -b \"$BOTTLE_NAME\" -e \"$EXEC_PATH\" -a \"$EXEC_ARGS\""
        else
            RUN_CMD="flatpak run --command=bottles-cli com.usebottles.bottles run -b \"$BOTTLE_NAME\" -e \"$EXEC_PATH\""
        fi
    fi
else
    # Utilisation de Wine standard avec WINEPREFIX
    # WINEPREFIX est déjà exporté, mais on le met aussi dans la commande pour être explicite
    if [[ "$EXT" == "bat" ]]; then
        RUN_CMD="WINEPREFIX=\"$WINEPREFIX\" $WINE_BINARY cmd /c \"$EXEC_PATH\" $EXEC_ARGS"
    else
        if [[ -n "$EXEC_ARGS" ]]; then
            RUN_CMD="WINEPREFIX=\"$WINEPREFIX\" $WINE_BINARY \"$EXEC_PATH\" $EXEC_ARGS"
        else
            RUN_CMD="WINEPREFIX=\"$WINEPREFIX\" $WINE_BINARY \"$EXEC_PATH\""
        fi
    fi
fi

# Affichage des informations
echo "========================================="
echo "Informations d'exécution :"
echo "========================================="
echo "Fichier WSquashFS : $WSQUASHFS_FILE"
echo "Point de montage  : $MOUNT_POINT"
echo "Préfixe Wine      : $WINEPREFIX"
echo "Chemin exécutable : $EXEC_PATH"
echo "Arguments         : $EXEC_ARGS"
echo ""
echo "Configuration :"
if [[ "$USE_BOTTLES" == true ]]; then
    echo "  Runtime         : Bottles ($BOTTLE_NAME)"
else
    echo "  Runtime         : Wine"
    echo "  Binary Wine     : $WINE_BINARY"
fi
echo "  Architecture    : $WINE_ARCH"
[[ -n "$WINE_VERSION" ]] && echo "  Version Wine    : $WINE_VERSION"
[[ -n "$PROTON_VERSION" ]] && echo "  Version Proton  : $PROTON_VERSION"
[[ -n "$RUNNER" ]] && echo "  Runner          : $RUNNER"
[[ "$DXVK" == "1" ]] && echo "  DXVK            : Activé"
[[ "$VKD3D" == "1" ]] && echo "  VKD3D           : Activé"
[[ "$ESYNC" == "1" ]] && echo "  ESYNC           : Activé"
[[ "$FSYNC" == "1" ]] && echo "  FSYNC           : Activé"
echo ""
echo "Commande          : $RUN_CMD"
echo "========================================="

# Exécution de la commande
eval $RUN_CMD

# Nettoyage
echo "Démontage de $MOUNT_POINT..."
umount "$MOUNT_POINT"

# Suppression du répertoire de montage
echo "Suppression du répertoire de montage : $MOUNT_POINT"
rmdir "$MOUNT_POINT" || echo "Attention : Impossible de supprimer le répertoire $MOUNT_POINT. Veuillez vérifier."

echo "Terminé."
