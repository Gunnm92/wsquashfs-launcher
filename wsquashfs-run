#!/bin/bash

# wsquashfs-run - Launcher pour fichiers WSquashFS (Batocera compatible)
# Basé sur le code de batocera-wine
# Usage: wsquashfs-run <fichier.wsquashfs>

set -e

# ============================================
# CONFIGURATION
# ============================================

# Répertoires de base (modifiable via variables d'environnement)
SAVES_DIR="${WSQUASHFS_SAVES_DIR:-$HOME/.local/share/wsquashfs/saves}"
WINEPREFIX_BASE="${WSQUASHFS_WINEPREFIX:-$HOME/.local/share/wsquashfs/prefix}"
CACHE_DIR="${WSQUASHFS_CACHE:-$HOME/.cache/wsquashfs}"

# ============================================
# FONCTIONS UTILITAIRES
# ============================================

# Fonction pour récupérer une variable depuis autorun.cmd
getWine_var() {
    local WINEPOINT=$1
    local WINEVAR=$2
    local WINEVALUE=$3

    if [[ -e "${WINEPOINT}/autorun.cmd" ]]; then
        local VAL=$(grep "^${WINEVAR}=" "${WINEPOINT}/autorun.cmd" 2>/dev/null | sed -e "s/^${WINEVAR}=//" | head -1)
        # Nettoyer les retours chariot Windows si dos2unix est disponible
        if command -v dos2unix &> /dev/null; then
            VAL=$(echo "$VAL" | dos2unix 2>/dev/null)
        else
            # Sinon, supprimer manuellement les \r
            VAL=$(echo "$VAL" | tr -d '\r')
        fi

        if [[ -n "${VAL}" ]]; then
            echo "${VAL}"
        else
            echo "${WINEVALUE}"
        fi
    else
        echo "${WINEVALUE}"
    fi
}

# Nettoyage en cas d'erreur
cleanup() {
    local EXIT_CODE=$?

    if [[ -n "${WINEPOINT}" ]] && mountpoint -q "${WINEPOINT}" 2>/dev/null; then
        echo "Démontage de ${WINEPOINT}..."
        umount "${WINEPOINT}" 2>/dev/null || true
    fi

    if [[ -n "${SQUASHFSPOINT}" ]] && mountpoint -q "${SQUASHFSPOINT}" 2>/dev/null; then
        echo "Démontage de ${SQUASHFSPOINT}..."
        umount "${SQUASHFSPOINT}" 2>/dev/null || true
    fi

    # Supprimer le répertoire de travail overlay
    [[ -n "${WORKPOINT}" && -d "${WORKPOINT}" ]] && rm -rf "${WORKPOINT}" 2>/dev/null || true

    exit $EXIT_CODE
}

trap cleanup EXIT INT TERM

# ============================================
# VÉRIFICATIONS ET COMMANDES
# ============================================

# Gestion des commandes spéciales
case "${1:-}" in
    --clean)
        echo "Nettoyage des fichiers temporaires wsquashfs..."
        rm -rf "${CACHE_DIR}/mnt"/* 2>/dev/null || true
        rm -rf "${CACHE_DIR}/wine"/* 2>/dev/null || true
        rm -rf "${CACHE_DIR}/work"/* 2>/dev/null || true
        echo "✓ Fichiers temporaires supprimés"
        echo ""
        echo "Note: Les sauvegardes sont préservées dans: ${SAVES_DIR}"
        exit 0
        ;;
    --help|-h)
        echo "Usage: $0 <fichier.wsquashfs>"
        echo "       $0 --clean"
        echo ""
        echo "Lance un jeu Windows empaqueté au format WSquashFS (Batocera)"
        echo ""
        echo "Options:"
        echo "  --clean               Nettoyer les fichiers temporaires"
        echo "  --help, -h            Afficher cette aide"
        echo ""
        echo "Variables d'environnement:"
        echo "  WSQUASHFS_SAVES_DIR   - Répertoire des sauvegardes (défaut: ~/.local/share/wsquashfs/saves)"
        echo "  WSQUASHFS_WINEPREFIX  - Répertoire des préfixes Wine (défaut: ~/.local/share/wsquashfs/prefix)"
        echo "  WSQUASHFS_CACHE       - Répertoire de cache (défaut: ~/.cache/wsquashfs)"
        echo ""
        echo "Exemples:"
        echo "  wsquashfs-run game.wsquashfs"
        echo "  wsquashfs-run --clean"
        exit 0
        ;;
esac

if [[ $# -ne 1 ]]; then
    echo "Erreur: Fichier .wsquashfs requis"
    echo "Usage: $0 <fichier.wsquashfs>"
    echo "       $0 --help pour plus d'informations"
    exit 1
fi

# Vérifier les dépendances de base
if ! command -v wine &> /dev/null; then
    echo "Erreur: wine n'est pas installé"
    exit 1
fi

# Vérifier que les outils requis sont disponibles
if ! command -v squashfuse &> /dev/null; then
    echo "Erreur: squashfuse n'est pas installé"
    echo "Installation: apt install squashfuse fuse-overlayfs"
    exit 1
fi

if ! command -v fuse-overlayfs &> /dev/null; then
    echo "Erreur: fuse-overlayfs n'est pas installé"
    echo "Installation: apt install squashfuse fuse-overlayfs"
    exit 1
fi

WSQUASHFS_FILE="$1"

# Vérification du fichier
if [[ ! -f "$WSQUASHFS_FILE" ]]; then
    echo "Erreur: Le fichier '$WSQUASHFS_FILE' n'existe pas"
    exit 1
fi

if [[ "${WSQUASHFS_FILE##*.}" != "wsquashfs" ]]; then
    echo "Attention: Le fichier ne semble pas avoir l'extension .wsquashfs"
fi

# Chemin absolu
WSQUASHFS_FILE=$(realpath "$WSQUASHFS_FILE")
GAME_NAME=$(basename "$WSQUASHFS_FILE" .wsquashfs)

echo "========================================="
echo "WSquashFS Launcher"
echo "========================================="
echo "Jeu: $GAME_NAME"
echo "Fichier: $WSQUASHFS_FILE"
echo "========================================="
echo ""

# ============================================
# PRÉPARATION DES RÉPERTOIRES
# ============================================

# Point de montage du squashfs (lecture seule)
SQUASHFSPOINT="${CACHE_DIR}/mnt/${GAME_NAME}"

# Point de montage overlay (lecture/écriture)
WINEPOINT="${CACHE_DIR}/wine/${GAME_NAME}"

# Répertoire de sauvegarde (upperdir pour overlay)
SAVEPOINT="${SAVES_DIR}/${GAME_NAME}"

# Répertoire de travail pour overlay
WORKPOINT="${CACHE_DIR}/work/${GAME_NAME}"

# Créer les répertoires nécessaires
mkdir -p "$SQUASHFSPOINT"
mkdir -p "$WINEPOINT"
mkdir -p "$SAVEPOINT"
mkdir -p "$WORKPOINT"

# ============================================
# DÉMONTAGE DES MONTAGES EXISTANTS
# ============================================

if mountpoint -q "$WINEPOINT" 2>/dev/null; then
    echo "Démontage du point overlay existant..."
    umount "$WINEPOINT" || {
        echo "Erreur: Impossible de démonter $WINEPOINT"
        exit 1
    }
fi

if mountpoint -q "$SQUASHFSPOINT" 2>/dev/null; then
    echo "Démontage du squashfs existant..."
    umount "$SQUASHFSPOINT" || {
        echo "Erreur: Impossible de démonter $SQUASHFSPOINT"
        exit 1
    }
fi

# Nettoyer les anciens répertoires unsquashfs
if [[ -d "$SQUASHFSPOINT" ]] && [[ ! "$(ls -A $SQUASHFSPOINT 2>/dev/null)" ]]; then
    rm -rf "$SQUASHFSPOINT"
    mkdir -p "$SQUASHFSPOINT"
fi

# ============================================
# MONTAGE DU SQUASHFS (squashfuse)
# ============================================

echo "Montage du fichier squashfs avec squashfuse..."
if ! squashfuse "$WSQUASHFS_FILE" "$SQUASHFSPOINT"; then
    echo "Erreur: Échec du montage du fichier squashfs"
    exit 1
fi
echo "✓ Squashfs monté sur: $SQUASHFSPOINT"

# ============================================
# MONTAGE OVERLAY
# ============================================

echo "Création du montage overlay..."

if ! fuse-overlayfs \
    -o lowerdir="${SQUASHFSPOINT}",upperdir="${SAVEPOINT}",workdir="${WORKPOINT}" \
    "${WINEPOINT}"; then
    echo "Erreur: Échec de la création de l'overlay"
    umount "$SQUASHFSPOINT" 2>/dev/null || true
    exit 1
fi

echo "✓ Overlay monté sur: $WINEPOINT"
echo "✓ Sauvegardes dans: $SAVEPOINT"

echo ""

# ============================================
# LECTURE DU FICHIER AUTORUN.CMD
# ============================================

if [[ ! -f "${WINEPOINT}/autorun.cmd" ]]; then
    echo "Erreur: Fichier autorun.cmd introuvable dans le squashfs"
    exit 1
fi

echo "Lecture de la configuration..."

# Variables de base
DIR=$(getWine_var "$WINEPOINT" "DIR" "")
CMD=$(getWine_var "$WINEPOINT" "CMD" "")

# Variables Wine/Proton
WINE_VERSION=$(getWine_var "$WINEPOINT" "WINE" "")
PROTON_VERSION=$(getWine_var "$WINEPOINT" "PROTON" "")
RUNNER=$(getWine_var "$WINEPOINT" "RUNNER" "")
WINE_ARCH=$(getWine_var "$WINEPOINT" "ARCH" "win64")

# Optimisations
DXVK=$(getWine_var "$WINEPOINT" "DXVK" "0")
VKD3D=$(getWine_var "$WINEPOINT" "VKD3D" "0")
ESYNC=$(getWine_var "$WINEPOINT" "ESYNC" "0")
FSYNC=$(getWine_var "$WINEPOINT" "FSYNC" "0")

# Variables additionnelles Batocera
WINE_LANG=$(getWine_var "$WINEPOINT" "LANG" "")
WINE_ENV=$(getWine_var "$WINEPOINT" "ENV" "")
SAVEDIR=$(getWine_var "$WINEPOINT" "SAVEDIR" "")
SAVEFILES=$(getWine_var "$WINEPOINT" "SAVEFILES" "")

# Vérification
if [[ -z "$CMD" ]]; then
    echo "Erreur: Variable CMD non définie dans autorun.cmd"
    exit 1
fi

# ============================================
# DÉTERMINATION DU CHEMIN EXÉCUTABLE
# ============================================

# Parser la commande en gérant les guillemets
# Format possible : "executable.exe" args
#                   executable.exe args
#                   "executable with spaces.exe" args

if [[ "$CMD" =~ ^\"([^\"]+)\"(.*)$ ]]; then
    # Commande entre guillemets
    EXEC_NAME="${BASH_REMATCH[1]}"
    EXEC_ARGS="${BASH_REMATCH[2]}"
    EXEC_ARGS="${EXEC_ARGS# }" # Enlever l'espace de début
else
    # Pas de guillemets, prendre le premier mot
    EXEC_NAME=$(echo "$CMD" | awk '{print $1}')
    EXEC_ARGS=$(echo "$CMD" | cut -d' ' -f2- -s)
fi

# Construire le chemin complet
if [[ -z "$DIR" ]]; then
    EXEC_PATH="${WINEPOINT}/${EXEC_NAME}"
else
    EXEC_PATH="${WINEPOINT}/${DIR}/${EXEC_NAME}"
fi

if [[ ! -f "$EXEC_PATH" ]]; then
    echo "Erreur: Exécutable introuvable: $EXEC_PATH"
    echo "Chemin cherché: $EXEC_PATH"
    echo "CMD original: $CMD"
    echo "EXEC_NAME extrait: $EXEC_NAME"
    echo "DIR: ${DIR:-<vide>}"
    exit 1
fi

# ============================================
# CONFIGURATION DE WINE
# ============================================

# IMPORTANT: Dans Batocera, le wsquashfs contient TOUT le prefix Wine (system.reg, user.reg, drive_c/, etc.)
# Le WINEPREFIX doit pointer vers le point de montage overlay (WINEPOINT), pas vers un sous-répertoire
export WINEPREFIX="${WINEPOINT}"
export WINEARCH="$WINE_ARCH"

# Vérifier si le squashfs contient déjà un préfixe Wine complet à la racine
if [[ -f "${WINEPOINT}/system.reg" ]] && [[ -d "${WINEPOINT}/drive_c" ]]; then
    echo "✓ Préfixe Wine complet détecté dans le wsquashfs (structure Batocera)"
else
    echo "Attention: Le wsquashfs ne contient pas un préfixe Wine complet à la racine"
    echo "Structure attendue: system.reg, user.reg, drive_c/, etc. à la racine du wsquashfs"

    # Si pas de préfixe dans le squashfs, en créer un
    echo "Création d'un nouveau préfixe Wine ($WINE_ARCH)..."
    WINEDLLOVERRIDES="mscoree,mshtml=" wineboot -u 2>&1 | grep -v "fixme:" || true
    wineserver -w 2>/dev/null || true
fi

# Optimisations
[[ "$ESYNC" == "1" ]] && export WINEESYNC=1
[[ "$FSYNC" == "1" ]] && export WINEFSYNC=1

# ============================================
# IMPORT DES FICHIERS .REG (comme Batocera)
# ============================================

# Chercher et importer les fichiers .reg dans /regs
if [[ -d "${WINEPOINT}/regs" ]]; then
    echo "Import des fichiers de registre..."
    while IFS= read -r -d '' regfile; do
        echo "  Importing: $(basename "$regfile")"
        wine regedit "//?/unix${regfile}" 2>/dev/null || true
    done < <(find "${WINEPOINT}/regs" -maxdepth 1 -type f -iname "*.reg" -print0)
fi

# ============================================
# DÉTERMINATION DU BINAIRE WINE
# ============================================

# Déterminer le binaire Wine
WINE_BINARY="wine"

if [[ -n "$WINE_VERSION" ]] && [[ -x "/opt/wine-${WINE_VERSION}/bin/wine" ]]; then
    WINE_BINARY="/opt/wine-${WINE_VERSION}/bin/wine"
fi

if [[ -n "$PROTON_VERSION" ]] && [[ -x "/usr/local/bin/proton" ]]; then
    WINE_BINARY="proton"
fi

if [[ -n "$RUNNER" ]] && [[ -x "$RUNNER" ]]; then
    WINE_BINARY="$RUNNER"
fi

# ============================================
# AFFICHAGE DES INFORMATIONS
# ============================================

echo "Configuration:"
echo "  Exécutable    : $EXEC_PATH"
echo "  Arguments     : ${EXEC_ARGS:-<aucun>}"
echo "  Wine          : $WINE_BINARY"
echo "  Architecture  : $WINE_ARCH"
echo "  Préfixe       : $WINEPREFIX"
[[ "$DXVK" == "1" ]] && echo "  DXVK          : Activé"
[[ "$VKD3D" == "1" ]] && echo "  VKD3D         : Activé"
[[ "$ESYNC" == "1" ]] && echo "  ESYNC         : Activé"
[[ "$FSYNC" == "1" ]] && echo "  FSYNC         : Activé"
echo ""
echo "========================================="
echo "Lancement du jeu..."
echo "========================================="
echo ""

# ============================================
# EXÉCUTION DU JEU
# ============================================

# Changer vers le répertoire de travail
WORKDIR="$WINEPOINT"
[[ -n "$DIR" ]] && WORKDIR="${WINEPOINT}/${DIR}"

cd "$WORKDIR" || exit 1

# Lancer le jeu
EXT="${EXEC_PATH##*.}"

# Construire la commande avec WINE_LANG et WINE_ENV (comme Batocera)
if [[ -n "$WINE_LANG" ]]; then
    export LC_ALL="$WINE_LANG"
    echo "Langue configurée : $WINE_LANG"
fi

# Exécuter avec les variables d'environnement personnalisées
if [[ "$EXT" == "bat" ]]; then
    if [[ -n "$WINE_ENV" ]]; then
        eval "$WINE_ENV" "$WINE_BINARY" cmd /c "$EXEC_PATH" $EXEC_ARGS
    else
        "$WINE_BINARY" cmd /c "$EXEC_PATH" $EXEC_ARGS
    fi
else
    if [[ -n "$WINE_ENV" ]]; then
        eval "$WINE_ENV" "$WINE_BINARY" "$EXEC_PATH" $EXEC_ARGS
    else
        "$WINE_BINARY" "$EXEC_PATH" $EXEC_ARGS
    fi
fi

EXIT_CODE=$?

echo ""
echo "========================================="
echo "Jeu terminé (code: $EXIT_CODE)"
echo "========================================="

exit $EXIT_CODE
